<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Cricket Tournament</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-green-600 to-green-800 text-white shadow-lg p-4 md:p-6 rounded-b-xl">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-2 md:mb-0">
                <span class="block text-yellow-300">Cricket Mania</span> Local Tournament
            </h1>
            <!-- Navigation -->
            <nav class="mt-3 md:mt-0">
                <ul class="flex flex-wrap justify-center space-x-4 md:space-x-6">
                    <li><a href="#home" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Home</a></li>
                    <li><a href="#teams" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Teams</a></li>
                    <li><a href="#schedule" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Schedule</a></li>
                    <li><a href="#results" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Results</a></li>
                    <li><a href="#standings" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Standings</a></li>
                    <li><a href="admin.html" class="hover:text-yellow-300 transition duration-300 text-lg font-medium">Admin Panel</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="home" class="relative bg-cover bg-center h-96 flex items-center justify-center text-white text-center rounded-xl mx-4 mt-6 shadow-xl"
        style="background-image: url('https://placehold.co/1200x500/0f8546/ffffff?text=Cricket+Ground+Background');">
        <div class="absolute inset-0 bg-black opacity-60 rounded-xl"></div>
        <div class="relative z-10 p-4">
            <h2 class="text-4xl md:text-6xl font-extrabold mb-4 drop-shadow-lg">Get Ready for the Action!</h2>
            <p class="text-lg md:text-2xl mb-6">Witness the thrill of local cricket. Join us!</p>
            <a href="#schedule" class="bg-yellow-400 hover:bg-yellow-500 text-green-900 font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 inline-block">
                View Schedule
            </a>
        </div>
    </section>

    <!-- About Tournament Section -->
    <section class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-6">About the Tournament</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <p class="text-lg leading-relaxed mb-4">
                    The "Cricket Mania Local Tournament" is an exciting event bringing together the best local cricket talent. Our aim is to foster community spirit, promote healthy competition, and celebrate the love for cricket.
                </p>
                <p class="text-lg leading-relaxed">
                    This year, we feature <span id="num-teams-about">0</span> dynamic teams battling it out for the coveted championship trophy. Expect thrilling matches, incredible catches, and unforgettable moments!
                </p>
            </div>
            <div class="flex items-center justify-center">
                <img src="https://placehold.co/400x250/0f8546/ffffff?text=Tournament+Trophy" alt="Tournament Trophy" class="rounded-lg shadow-md">
            </div>
        </div>
    </section>

    <!-- Teams Section -->
    <section id="teams" class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-8">Participating Teams</h2>
        <div id="teams-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Team cards will be dynamically loaded here -->
            <p class="col-span-full text-center text-gray-500" id="teams-loading-message">Loading teams...</p>
        </div>
    </section>

    <!-- Schedule Section -->
    <section id="schedule" class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-8">Match Schedule</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-green-700 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tl-lg">Date</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Time</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Match</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Venue</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tr-lg">Status</th>
                    </tr>
                </thead>
                <tbody id="schedule-table-body">
                    <!-- Schedule rows will be dynamically loaded here -->
                    <tr><td colspan="5" class="py-4 text-center text-gray-500" id="schedule-loading-message">Loading schedule...</td></tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Results Section -->
    <section id="results" class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-8">Latest Results</h2>
        <div id="results-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Results cards will be dynamically loaded here -->
            <p class="col-span-full text-center text-gray-500" id="results-loading-message">Loading results...</p>
        </div>
    </section>

    <!-- Standings Section -->
    <section id="standings" class="container mx-auto my-10 p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-center text-green-700 mb-8">Tournament Standings</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead class="bg-green-700 text-white">
                    <tr>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tl-lg">Pos</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">Team</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">P</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">W</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">L</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold">NRR</th>
                        <th class="py-3 px-4 text-left text-sm font-semibold rounded-tr-lg">Pts</th>
                    </tr>
                </thead>
                <tbody id="standings-table-body">
                    <!-- Standings rows will be dynamically loaded here -->
                    <tr><td colspan="7" class="py-4 text-center text-gray-500" id="standings-loading-message">Loading standings...</td></tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-6 md:p-8 mt-10 rounded-t-xl">
        <div class="container mx-auto text-center">
            <p class="text-lg">&copy; 2025 Cricket Mania Tournament. All rights reserved.</p>
            <div class="flex justify-center space-x-6 mt-4">
                <a href="#" class="hover:text-green-400 transition duration-300">Privacy Policy</a>
                <a href="#" class="hover:text-green-400 transition duration-300">Terms of Service</a>
                <a href="#" class="hover:text-green-400 transition duration-300">Contact Us</a>
            </div>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let allTeams = []; // Global array to store teams for dropdowns
        let allMatches = []; // Global array to store matches

        // Canvas environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Firestore collection paths
        const publicDataPath = `artifacts/${appId}/public/data`;
        const teamsCollectionRef = (db) => collection(db, `${publicDataPath}/teams`);
        const matchesCollectionRef = (db) => collection(db, `${publicDataPath}/matches`);

        // Public View Elements
        const numTeamsAbout = document.getElementById('num-teams-about');
        const teamsList = document.getElementById('teams-list');
        const teamsLoadingMessage = document.getElementById('teams-loading-message');
        const scheduleTableBody = document.getElementById('schedule-table-body');
        const scheduleLoadingMessage = document.getElementById('schedule-loading-message');
        const resultsList = document.getElementById('results-list');
        const resultsLoadingMessage = document.getElementById('results-loading-message');
        const standingsTableBody = document.getElementById('standings-table-body');
        const standingsLoadingMessage = document.getElementById('standings-loading-message');

        // --- Firebase Initialization and Auth ---
        window.onload = async function() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate user (for public data access, anonymous sign-in is sufficient)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Start fetching and rendering data
                setupRealtimeListeners();

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                // Display a user-friendly error message if needed
            }
        };

        // --- Real-time Data Listeners (Public View) ---
        function setupRealtimeListeners() {
            // Listen for Teams
            onSnapshot(teamsCollectionRef(db), (snapshot) => {
                allTeams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTeams(allTeams); // For public view
                numTeamsAbout.textContent = allTeams.length; // Update about section
                teamsLoadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching teams:", error);
                teamsLoadingMessage.textContent = "Failed to load teams.";
            });

            // Listen for Matches
            onSnapshot(matchesCollectionRef(db), (snapshot) => {
                allMatches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedule(allMatches, allTeams); // For public view
                renderResults(allMatches, allTeams); // For public view
                renderStandings(allMatches, allTeams); // For public view
                scheduleLoadingMessage.classList.add('hidden');
                resultsLoadingMessage.classList.add('hidden');
                standingsLoadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error fetching matches:", error);
                scheduleLoadingMessage.textContent = "Failed to load schedule.";
                resultsLoadingMessage.textContent = "Failed to load results.";
                standingsLoadingMessage.textContent = "Failed to load standings.";
            });
        }

        // --- Render Functions for Public View ---
        function renderTeams(teams) {
            teamsList.innerHTML = '';
            if (teams.length === 0) {
                teamsList.innerHTML = '<p class="col-span-full text-center text-gray-500">No teams added yet.</p>';
                return;
            }
            teams.forEach(team => {
                const teamCard = `
                    <div class="bg-gray-100 p-4 rounded-lg shadow-md hover:shadow-xl transition duration-300 transform hover:-translate-y-1">
                        <img src="${team.logoUrl || `https://placehold.co/100x100/0f8546/ffffff?text=${team.name.split(' ').map(n => n[0]).join('')}`}" alt="${team.name} Logo" class="w-24 h-24 mx-auto mb-3 rounded-full border-4 border-green-500">
                        <h3 class="text-xl font-semibold text-center text-green-800">${team.name}</h3>
                        <p class="text-center text-gray-600 text-sm">Captain: ${team.captain}</p>
                    </div>
                `;
                teamsList.insertAdjacentHTML('beforeend', teamCard);
            });
        }

        function renderSchedule(matches, teams) {
            scheduleTableBody.innerHTML = '';
            const upcomingMatches = matches.filter(match => match.status === 'Upcoming' || match.status === 'Live')
                                           .sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));

            if (upcomingMatches.length === 0) {
                scheduleTableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No upcoming matches scheduled.</td></tr>';
                return;
            }

            upcomingMatches.forEach(match => {
                const team1 = teams.find(t => t.id === match.team1Id);
                const team2 = teams.find(t => t.id === match.team2Id);
                const statusColor = match.status === 'Upcoming' ? 'text-blue-600' : 'text-orange-600';
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-4">${match.date}</td>
                        <td class="py-3 px-4">${match.time}</td>
                        <td class="py-3 px-4 font-medium">${team1?.name || 'Unknown Team'} vs ${team2?.name || 'Unknown Team'}</td>
                        <td class="py-3 px-4">${match.venue}</td>
                        <td class="py-3 px-4 ${statusColor}">${match.status}</td>
                    </tr>
                `;
                scheduleTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        function renderResults(matches, teams) {
            resultsList.innerHTML = '';
            const completedMatches = matches.filter(match => match.status === 'Completed')
                                            .sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)); // Latest first

            if (completedMatches.length === 0) {
                resultsList.innerHTML = '<p class="col-span-full text-center text-gray-500">No results available yet.</p>';
                return;
            }

            completedMatches.forEach(match => {
                const team1 = teams.find(t => t.id === match.team1Id);
                const team2 = teams.find(t => t.id === match.team2Id);
                const winnerTeam = teams.find(t => t.id === match.winner);
                const resultCard = `
                    <div class="bg-gray-100 p-5 rounded-lg shadow-md border-l-4 border-green-600">
                        <p class="text-sm text-gray-500 mb-2">${match.date} - ${match.time}</p>
                        <h3 class="text-xl font-semibold text-green-800 mb-3">${team1?.name || 'Unknown Team'} vs ${team2?.name || 'Unknown Team'}</h3>
                        <p class="text-lg mb-2">${team1?.name || 'Unknown Team'}: ${match.team1Score || 'N/A'} (${match.team1Overs || 'N/A'} overs)</p>
                        <p class="text-lg mb-3">${team2?.name || 'Unknown Team'}: ${match.team2Score || 'N/A'} (${match.team2Overs || 'N/A'} overs)</p>
                        <p class="text-green-600 font-bold text-md">${winnerTeam?.name || 'Unknown'} won ${match.winMargin || 'by unknown margin'}</p>
                    </div>
                `;
                resultsList.insertAdjacentHTML('beforeend', resultCard);
            });
        }

        function renderStandings(matches, teams) {
            standingsTableBody.innerHTML = '';
            const standings = calculateStandings(teams, matches);

            if (standings.length === 0) {
                standingsTableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">No standings data available yet.</td></tr>';
                return;
            }

            standings.forEach(team => {
                const row = `
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-3 px-4">${team.Pos}</td>
                        <td class="py-3 px-4 font-medium">${team.name}</td>
                        <td class="py-3 px-4">${team.P}</td>
                        <td class="py-3 px-4">${team.W}</td>
                        <td class="py-3 px-4">${team.L}</td>
                        <td class="py-3 px-4">${team.NRR}</td>
                        <td class="py-3 px-4 font-bold">${team.Pts}</td>
                    </tr>
                `;
                standingsTableBody.insertAdjacentHTML('beforeend', row);
            });
        }

        // --- Standings Calculation Logic ---
        function calculateStandings(teams, matches) {
            const standingsMap = new Map();

            // Initialize standings for all teams
            teams.forEach(team => {
                standingsMap.set(team.id, {
                    id: team.id,
                    name: team.name,
                    P: 0, // Played
                    W: 0, // Wins
                    L: 0, // Losses
                    NRR: 0, // Net Run Rate (simplified for this example)
                    Pts: 0, // Points
                    runsScored: 0,
                    oversFaced: 0,
                    runsConceded: 0,
                    oversBowled: 0
                });
            });

            matches.forEach(match => {
                // Only process completed matches
                if (match.status === 'Completed' && match.winner && match.team1Score && match.team2Score && match.team1Overs && match.team2Overs) {
                    const team1Stats = standingsMap.get(match.team1Id);
                    const team2Stats = standingsMap.get(match.team2Id);

                    if (!team1Stats || !team2Stats) return; // Skip if team data is missing

                    // Increment played matches
                    team1Stats.P += 1;
                    team2Stats.P += 1;

                    // Update wins, losses, and points
                    if (match.winner === match.team1Id) {
                        team1Stats.W += 1;
                        team1Stats.Pts += 2; // Assuming 2 points for a win
                        team2Stats.L += 1;
                    } else if (match.winner === match.team2Id) {
                        team2Stats.W += 1;
                        team2Stats.Pts += 2;
                        team1Stats.L += 1;
                    }

                    // Parse scores and overs
                    const parseScore = (scoreStr) => {
                        const parts = scoreStr.split('/');
                        return parseInt(parts[0]);
                    };
                    const team1Runs = parseScore(match.team1Score);
                    const team2Runs = parseScore(match.team2Score);
                    const team1Overs = parseFloat(match.team1Overs);
                    const team2Overs = parseFloat(match.team2Overs);

                    // Update runs scored/conceded and overs faced/bowled
                    team1Stats.runsScored += team1Runs;
                    team1Stats.oversFaced += team1Overs;
                    team1Stats.runsConceded += team2Runs;
                    team1Stats.oversBowled += team2Overs;

                    team2Stats.runsScored += team2Runs;
                    team2Stats.oversFaced += team2Overs;
                    team2Stats.runsConceded += team1Runs;
                    team2Stats.oversBowled += team1Overs;
                }
            });

            // Calculate NRR for each team
            standingsMap.forEach(team => {
                let runRateFor = team.oversFaced > 0 ? team.runsScored / team.oversFaced : 0;
                let runRateAgainst = team.oversBowled > 0 ? team.runsConceded / team.oversBowled : 0;
                team.NRR = (runRateFor - runRateAgainst).toFixed(3); // Simplified NRR
            });

            // Convert map to array and sort
            const sortedStandings = Array.from(standingsMap.values()).sort((a, b) => {
                if (b.Pts !== a.Pts) {
                    return b.Pts - a.Pts; // Sort by points (descending)
                }
                return parseFloat(b.NRR) - parseFloat(a.NRR); // Then by NRR (descending)
            });

            // Assign positions
            return sortedStandings.map((team, index) => ({ ...team, Pos: index + 1 }));
        }

    </script>
</body>
</html>
